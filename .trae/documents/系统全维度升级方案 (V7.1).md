# 系统全维度升级方案 (V7.1) - 深度交互与反馈闭环

基于上一阶段 (V7.0) 建立的混合检索基座，本轮升级将聚焦于 **提升数据交互的实时性** 和 **完善智能反馈闭环**。这是让系统从“可用”迈向“专业”的关键一步。

## 1. 架构升级：负反馈自动修正闭环 (Feedback Loop)
*   **痛点**: 目前用户点“踩”后，错误的 SQL 仍然可能通过语义缓存被再次检索出来，导致错误持续存在。
*   **方案**:
    1.  **实现缓存清理**: 在 `src/api/routes/feedback.py` 中，当收到负反馈时，自动计算 Query 的 Embedding，并从 ChromaDB (Semantic Cache) 中**物理删除**最相似的那条记录。
    2.  **负样本库**: 可选方案，将错误的 `(Query, SQL)` 存入一个专门的“反例库”，在 Prompt 中提示模型“不要这样做”。（本期暂不实现，优先做好清理）。

## 2. 功能增强：SQL 结果流式传输 (Streaming Data)
*   **痛点**: 对于大结果集（如 1000 行），用户需要等待后端全部取回、脱敏、JSON 序列化后才能看到第一行数据，首屏延迟高。
*   **方案**:
    *   **后端**: 改造 `src/workflow/nodes/execute.py`，虽然 LangGraph 节点本身是函数式的，但我们可以让 `execute_sql_node` 返回一个特殊的 `StreamingArtifact`。
    *   **API**: 在 `src/api/routes/chat.py` 中，识别到 SQL 执行节点时，使用 `yield` 逐行读取数据库游标，并实时推送到 SSE (Server-Sent Events) 流中。
    *   **注意**: 这是一个较大的架构变动，鉴于当前稳定性优先，**本期暂不实施全链路流式数据**，而是优化 **“分块加载” (Chunked Loading)** 体验：在前端 Table 组件支持分页，后端 SQL 保持 `LIMIT 1000` 但快速返回。

## 3. 用户体验：智能澄清与多轮对话 (Clarification)
*   **现状**: `ClarifyIntent` 节点目前逻辑较简单，容易被跳过。
*   **升级**:
    *   在 `src/workflow/nodes/clarify.py` 中引入**“歧义检测器”**。如果 `select_tables` 返回了两个非常相似的表（如 `sales_2023` 和 `sales_2024`），主动暂停并反问用户。

---

## 本次迭代实施重点 (MVP Plan)

为了快速响应“继续升级”的指令，我们将落地以下 **高收益** 功能：

### 1. 完善负反馈处理 (Fix Feedback)
*   **目标**: 彻底解决“点踩后依然答错”的问题。
*   **动作**: 完善 `src/api/routes/feedback.py` 中的 `TODO`，实现 `semantic_cache.delete(query)` 逻辑。

### 2. 增强意图澄清 (Smart Clarify)
*   **目标**: 减少幻觉，提升准确率。
*   **动作**: 优化 `src/workflow/nodes/clarify.py`，增加基于 Schema 相似度的歧义检测逻辑。

### 3. 数据洞察 UI 适配 (Insight UI)
*   **目标**: 让 V7.0 实现的 `InsightMiner` 结果在前端可见。
*   **动作**: 修改 `frontend/src/components/ChatWindow.tsx`，在消息卡片底部渲染 `Insights` 部分（灯泡图标 + 列表）。
