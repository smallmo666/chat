# 系统安全与代码质量优化计划 (V5.1)

基于代码走查结果，我制定了以下优化计划，重点解决 Python 沙箱的 DoS 风险、SQL 注入隐患以及清理废弃代码。

## 1. 核心安全修复 (Security Fixes)

### 1.1 Python 沙箱强化 (src/domain/sandbox.py)
*   **问题**: `exec` 执行在主进程中，若用户代码包含死循环 (`while True`)，会导致整个后端服务卡死 (DoS)。
*   **修复方案**:
    *   引入 `func_timeout` 库，为代码执行设置强制超时时间（例如 5 秒）。
    *   虽然多线程无法完全终止死循环（Python GIL 限制），但 `func_timeout` 可以在一定程度上利用子线程/信号机制进行控制，或者我们可以将执行逻辑放入 `multiprocessing` 进程池中（更彻底但开销大，考虑到 MVP，先用超时装饰器）。
    *   清理未使用的 `traceback` 导入和残留的 debug 注释。

### 1.2 防止 SQL 注入 (src/domain/schema/value.py)
*   **问题**: `get_distinct_values` 函数使用 f-string 拼接表名和列名，存在注入风险。
*   **修复方案**:
    *   增加 `validate_identifier` 函数，正则校验表名和列名仅包含 `[a-zA-Z0-9_.]`。
    *   使用 SQLAlchemy 的 `quoted_name` 确保标识符被正确引用。

### 1.3 生产环境配置检查 (src/core/config.py)
*   **问题**: `SECRET_KEY` 有弱默认值。
*   **修复方案**: 在应用启动时检查，如果使用的是默认值且环境非 `development`，则打印严重警告或阻止启动。

## 2. 代码清理与维护 (Code Cleanup)

### 2.1 移除废弃的节点代码
*   **任务**: 检查 `src/workflow/nodes`，确认是否有不再被 `graph.py` 引用的旧节点文件（如旧版可视化节点），并将其移除或标记为 `Deprecated`。
*   **前端清理**: 检查前端 `components` 目录，移除未使用的旧版组件。

## 3. 执行步骤
1.  **依赖安装**: 安装 `func-timeout`。
2.  **沙箱重构**: 修改 `StatefulSandbox.execute` 方法，增加超时控制。
3.  **SQL 安全**: 修改 `src/domain/schema/value.py`。
4.  **清理**: 删除 `sandbox.py` 中的死代码。

---
**确认**: 您是否同意优先处理这些高风险的安全漏洞？
