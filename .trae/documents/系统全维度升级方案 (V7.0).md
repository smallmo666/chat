# 系统全维度升级方案 (V7.0)

基于对当前架构（V6.0）的深入分析，我们已经建立了一个包含**连接池化**、**全链路追踪**、**语义缓存**、**智能表选择**和**Few-Shot 自进化**的强大基座。

针对您提出的“性能、功能、架构、用户体验”四大维度，我为您制定了 V7.0 的全维度升级方案。本次升级的核心主题是：**从“可用”到“好用”，从“被动响应”到“主动智能”**。

## 1. 架构升级：混合检索与流式交互 (Architecture)

### 1.1 引入混合检索 (Hybrid Search)
*   **现状**: 表选择和 Few-Shot 仅依赖向量相似度（Dense Retrieval）。
*   **痛点**: 此时对于专有名词（如特定的产品型号、ID）检索效果不佳。
*   **方案**: 引入 **BM25 关键词检索**，与向量检索进行加权融合（Reciprocal Rank Fusion, RRF）。这能显著提高对特定字段名、表名缩写的召回率。

### 1.2 彻底的流式架构 (Full Streaming)
*   **现状**: 虽然支持流式输出，但图表和表格数据仍然是生成完成后一次性推送到前端。
*   **方案**:
    *   **后端**: 改造 `ExecuteSQL` 节点，使用 `yield` 逐步返回数据（对于大结果集）。
    *   **前端**: 引入 `StreamableUI`，实现“边生成 SQL，边预加载表头；边查数据，边渲染图表”的极致体验。

## 2. 功能增强：深度分析与多模态 (Functionality)

### 2.1 智能数据洞察 (Automated Insights)
*   **现状**: 仅展示查询结果。
*   **升级**: 新增 `InsightMiner` 节点。在返回数据的同时，自动计算：
    *   **趋势分析**: "相比上月增长 15%..."
    *   **异常检测**: "注意：11月3日的数据存在异常峰值..."
    *   **关键驱动因素**: "增长主要由 X 产品线驱动..."

### 2.2 多模态输入 (Multimodal Input)
*   **方案**: 允许用户上传 Excel/CSV 文件或数据库 ER 图截图。
    *   **流程**: `FileParser` -> `SchemaExtraction` -> `KnowledgeGraph`。让 AI 能够基于用户上传的临时数据进行联合分析。

## 3. 性能优化：预计算与边缘缓存 (Performance)

### 3.1 预计算层 (Pre-computation Layer)
*   **痛点**: 对于“昨天的日活”、“上周的 GMV”等高频指标，每次都由 Text2SQL 现算太慢。
*   **方案**: 引入 **Metric Store (指标层)**。
    *   定义标准指标（YAML 配置）。
    *   后台定时任务（Celery）预计算热点指标存入 Redis。
    *   Query 阶段优先匹配指标层，直接返回毫秒级结果。

### 3.2 前端边缘缓存 (Edge Caching)
*   **方案**: 利用 Service Worker 或 React Query 在浏览器端缓存 Schema 和基础配置信息，减少 90% 的初始化网络请求。

## 4. 用户体验：自然语言交互进化 (User Experience)

### 4.1 交互式图表编辑 (Chat-to-Chart)
*   **现状**: 只能看图。
*   **升级**: 允许用户通过对话修改图表。
    *   用户: "把柱状图改成折线图，颜色换成红色。"
    *   系统: 实时更新 ECharts 配置，无需重新查库。

### 4.2 智能纠错与引导 (Smart Suggestion)
*   **方案**: 当用户提问模糊时（如"查一下数据"），不再直接报错，而是基于当前 Schema 生成 3 个可能的意图推荐（Suggestion Chips）。

---

## 本次迭代实施重点 (MVP Plan)

鉴于升级内容庞大，建议优先落地以下 **高价值、低成本** 的功能：

### 1. 增强型表选择 (Hybrid Table Selection)
*   **目标**: 解决特定表名搜不到的问题。
*   **动作**: 在 `src/domain/schema/search.py` 中引入 BM25 算法，与 ChromaDB 结果融合。

### 2. 交互式图表修正 (UI Artist Agent)
*   **目标**: 提升图表可用性。
*   **动作**: 新增 `UIArtist` 节点，专门处理用户的“改图”指令，只修改 JSON 配置不查库。

### 3. 智能数据洞察 (Basic Insight)
*   **目标**: 增加结果的信息量。
*   **动作**: 在 `ExecuteSQL` 后增加一个轻量级 LLM 调用，对 Data Frame 进行文本总结。
